<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin ‚Ä¢ AgriConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); }
        .sidebar-link { transition: all 0.2s; }
        .sidebar-link:hover { background: rgba(16, 185, 129, 0.15); }
        .sidebar-link-active { background: #10b981; color: white; }
        .stat-card { transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-4px); }
        table { border-collapse: separate; border-spacing: 0 8px; }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 min-h-screen">
    <div class="flex h-screen">
        <!-- SIDEBAR -->
        <div class="w-72 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800 flex items-center gap-3">
                <div class="bg-green-600 w-9 h-9 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-seedling text-white text-2xl"></i>
                </div>
                <div>
                    <span class="text-2xl font-bold tracking-tighter text-white">AgriConnect</span>
                    <p class="text-[10px] text-green-400 -mt-1 font-mono">ADMIN PANEL</p>
                </div>
            </div>

            <div class="flex-1 py-8 px-4">
                <nav class="space-y-1">
                    <a onclick="showSection('overview')" id="nav-overview" 
                       class="sidebar-link sidebar-link-active flex items-center gap-3 px-6 py-3.5 rounded-2xl text-sm font-medium cursor-pointer">
                        <i class="fas fa-tachometer-alt w-5"></i>
                        <span>Overview</span>
                    </a>
                    <a onclick="showSection('users')" id="nav-users"
                       class="sidebar-link flex items-center gap-3 px-6 py-3.5 rounded-2xl text-sm font-medium cursor-pointer">
                        <i class="fas fa-users w-5"></i>
                        <span>Farmers</span>
                    </a>
                    <a onclick="showSection('listings')" id="nav-listings"
                       class="sidebar-link flex items-center gap-3 px-6 py-3.5 rounded-2xl text-sm font-medium cursor-pointer">
                        <i class="fas fa-store w-5"></i>
                        <span>Listings</span>
                    </a>
                    <a onclick="showSection('analytics')" id="nav-analytics"
                       class="sidebar-link flex items-center gap-3 px-6 py-3.5 rounded-2xl text-sm font-medium cursor-pointer">
                        <i class="fas fa-chart-line w-5"></i>
                        <span>Analytics</span>
                    </a>
                </nav>
            </div>

            <div class="p-6 border-t border-gray-800">
                <div id="admin-info" class="flex items-center gap-3 px-4 py-3 bg-gray-800 rounded-2xl">
                    <div class="w-9 h-9 bg-green-500 rounded-2xl flex items-center justify-center text-white font-bold">A</div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm" id="admin-name">Admin</p>
                        <p class="text-green-400 text-xs" id="admin-email"></p>
                    </div>
                </div>
                <button onclick="logout()" 
                        class="mt-6 w-full flex items-center justify-center gap-2 bg-red-600/10 hover:bg-red-600/20 text-red-400 py-3 rounded-2xl font-medium transition">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- TOP BAR -->
            <div class="h-16 bg-gray-900 border-b border-gray-800 px-8 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 id="page-title" class="text-2xl font-semibold text-white">Overview</h1>
                    <div id="live-dot" class="flex items-center gap-1.5 text-xs bg-green-900 text-green-400 px-3 py-1 rounded-full">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        LIVE
                    </div>
                </div>
                
                <div class="flex items-center gap-6 text-sm">
                    <div class="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-3xl">
                        <i class="fas fa-calendar text-green-400"></i>
                        <span id="current-date" class="font-medium"></span>
                    </div>
                    <div onclick="refreshAll()" class="cursor-pointer hover:text-green-400 transition flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        <span class="text-xs font-medium">REFRESH</span>
                    </div>
                </div>
            </div>

            <!-- CONTENT AREA -->
            <div class="flex-1 overflow-auto p-8">
                
                <!-- OVERVIEW SECTION -->
                <div id="section-overview" class="space-y-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <!-- Stat 1 -->
                        <div class="stat-card bg-gray-900 border border-green-500/20 rounded-3xl p-6">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs text-gray-400 font-medium tracking-widest">TOTAL FARMERS</p>
                                    <p id="stat-users" class="text-5xl font-bold text-white mt-3">248</p>
                                </div>
                                <div class="w-12 h-12 bg-green-500/10 rounded-2xl flex items-center justify-center text-3xl">üë®‚Äçüåæ</div>
                            </div>
                            <p class="text-green-400 text-sm mt-6 flex items-center gap-1">
                                <i class="fas fa-arrow-up"></i> +12 this week
                            </p>
                        </div>
                        
                        <!-- Stat 2 -->
                        <div class="stat-card bg-gray-900 border border-green-500/20 rounded-3xl p-6">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs text-gray-400 font-medium tracking-widest">LIVE LISTINGS</p>
                                    <p id="stat-listings" class="text-5xl font-bold text-white mt-3">87</p>
                                </div>
                                <div class="w-12 h-12 bg-amber-500/10 rounded-2xl flex items-center justify-center text-3xl">üåΩ</div>
                            </div>
                            <p class="text-green-400 text-sm mt-6 flex items-center gap-1">
                                <i class="fas fa-arrow-up"></i> +7 today
                            </p>
                        </div>
                        
                        <!-- Stat 3 -->
                        <div class="stat-card bg-gray-900 border border-green-500/20 rounded-3xl p-6">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs text-gray-400 font-medium tracking-widest">TONS LISTED</p>
                                    <p id="stat-tons" class="text-5xl font-bold text-white mt-3">1,642</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-500/10 rounded-2xl flex items-center justify-center text-3xl">üì¶</div>
                            </div>
                            <p class="text-green-400 text-sm mt-6">Across all produce</p>
                        </div>
                        
                        <!-- Stat 4 -->
                        <div class="stat-card bg-gray-900 border border-green-500/20 rounded-3xl p-6">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs text-gray-400 font-medium tracking-widest">EST. VALUE</p>
                                    <p id="stat-value" class="text-5xl font-bold text-white mt-3">R4.8m</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-500/10 rounded-2xl flex items-center justify-center text-3xl">üí∞</div>
                            </div>
                            <p class="text-green-400 text-sm mt-6">Marketplace value</p>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-gray-900 rounded-3xl p-8">
                        <div class="flex justify-between mb-6">
                            <h2 class="text-lg font-semibold">Recent Listings</h2>
                            <button onclick="showSection('listings')" 
                                    class="text-green-400 text-sm flex items-center gap-2 hover:underline">
                                View all <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        <div id="recent-listings" class="space-y-3 text-sm">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- USERS SECTION -->
                <div id="section-users" class="hidden">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-semibold">Registered Farmers</h2>
                        <div class="relative w-80">
                            <input id="user-search" type="text" placeholder="Search farmers..." 
                                   onkeyup="filterUsers()" 
                                   class="w-full bg-gray-800 border border-gray-700 focus:border-green-500 rounded-3xl py-3 px-5 pl-12 text-sm outline-none">
                            <i class="fas fa-search absolute left-5 top-3.5 text-gray-500"></i>
                        </div>
                    </div>
                    <div class="bg-gray-900 rounded-3xl overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="px-8 py-5 text-left text-xs font-medium text-gray-400">NAME</th>
                                    <th class="px-8 py-5 text-left text-xs font-medium text-gray-400">EMAIL</th>
                                    <th class="px-8 py-5 text-left text-xs font-medium text-gray-400">JOINED</th>
                                    <th class="px-8 py-5 text-center text-xs font-medium text-gray-400">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="users-table" class="divide-y divide-gray-800">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- LISTINGS SECTION -->
                <div id="section-listings" class="hidden">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-semibold">All Marketplace Listings</h2>
                        <div class="flex gap-3">
                            <input id="listing-search" type="text" placeholder="Search listings..." 
                                   onkeyup="filterListings()" 
                                   class="bg-gray-800 border border-gray-700 focus:border-green-500 rounded-3xl py-3 px-5 pl-12 text-sm outline-none w-80">
                            <button onclick="refreshListings()" 
                                    class="px-6 bg-green-600 hover:bg-green-500 transition text-white rounded-3xl flex items-center gap-2">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-900 rounded-3xl overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="px-8 py-5 text-left text-xs font-medium text-gray-400">PRODUCE</th>
                                    <th class="px-8 py-5 text-left text-xs font-medium text-gray-400">PRICE / TON</th>
                                    <th class="px-8 py-5 text-left text-xs font-medium text-gray-400">QTY</th>
                                    <th class="px-8 py-5 text-left text-xs font-medium text-gray-400">LOCATION</th>
                                    <th class="px-8 py-5 text-left text-xs font-medium text-gray-400">SELLER</th>
                                    <th class="px-8 py-5 text-center text-xs font-medium text-gray-400">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="listings-table" class="divide-y divide-gray-800">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ANALYTICS SECTION -->
                <div id="section-analytics" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-900 rounded-3xl p-8">
                            <h3 class="font-semibold mb-6">Listings Growth (Last 30 Days)</h3>
                            <canvas id="growthChart" height="120"></canvas>
                        </div>
                        <div class="bg-gray-900 rounded-3xl p-8">
                            <h3 class="font-semibold mb-6">Produce Distribution</h3>
                            <canvas id="produceChart" height="120"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER BAR -->
            <div class="h-14 bg-gray-900 border-t border-gray-800 flex items-center px-8 text-xs text-gray-500">
                <div>AgriConnect Admin ‚Ä¢ Firebase Realtime Database ‚Ä¢ Johannesburg, ZA</div>
                <div class="flex-1"></div>
                <div id="last-updated" class="font-mono">Last updated just now</div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="hidden fixed bottom-8 right-8 bg-green-600 text-white px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-3 z-50">
        <i class="fas fa-check-circle"></i>
        <span id="toast-text" class="font-medium"></span>
    </div>

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

    <script>
        // ==================== FIREBASE CONFIG (same as main site) ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDQZFUK4hnd-_lHUCfi_EHZ1gMM7p1rurE",
            authDomain: "agriconnect-a813a.firebaseapp.com",
            projectId: "agriconnect-a813a",
            storageBucket: "agriconnect-a813a.firebasestorage.app",
            messagingSenderId: "426251328870",
            appId: "1:426251328870:web:742e51f276a1206d10fca7",
            measurementId: "G-LERNRKQ4S7"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let listingsData = {};
        let usersData = {};
        let growthChart, produceChart;

        // ==================== ADMIN AUTH CHECK ====================
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = "index.html"; // redirect to main site to login
                return;
            }
            // ADMIN EMAIL CHECK (change this to your preferred admin email)
            if (user.email !== "admin@agriconnect.co.za") {
                alert("‚õî Access Denied.\n\nOnly the admin account (admin@agriconnect.co.za) can access this dashboard.");
                auth.signOut();
                window.location.href = "index.html";
                return;
            }
            currentUser = user;
            document.getElementById('admin-name').textContent = user.displayName || "Admin";
            document.getElementById('admin-email').textContent = user.email;
            initDashboard();
        });

        // ==================== INIT DASHBOARD ====================
        function initDashboard() {
            updateDate();
            loadAllData();
            initCharts();
            setInterval(() => {
                document.getElementById('last-updated').textContent = `Last updated ${new Date().toLocaleTimeString()}`;
            }, 30000);
        }

        function updateDate() {
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-ZA', options);
        }

        // ==================== DATA LOADING ====================
        function loadAllData() {
            // Users
            db.ref('users').on('value', snapshot => {
                usersData = snapshot.val() || {};
                renderUsersTable();
                updateStats();
            });

            // Listings
            db.ref('listings').on('value', snapshot => {
                listingsData = snapshot.val() || {};
                renderListingsTable();
                renderRecentListings();
                updateStats();
            });
        }

        function updateStats() {
            const userCount = Object.keys(usersData).length;
            const listingCount = Object.keys(listingsData).length;
            
            let totalTons = 0;
            let totalValue = 0;
            
            Object.values(listingsData).forEach(l => {
                totalTons += parseFloat(l.quantity) || 0;
                totalValue += (parseFloat(l.price) || 0) * (parseFloat(l.quantity) || 0);
            });

            document.getElementById('stat-users').textContent = userCount;
            document.getElementById('stat-listings').textContent = listingCount;
            document.getElementById('stat-tons').textContent = totalTons.toLocaleString();
            document.getElementById('stat-value').textContent = `R${(totalValue/1000000).toFixed(1)}m`;
        }

        // ==================== RENDER TABLES ====================
        function renderUsersTable() {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = '';
            
            Object.values(usersData).forEach(user => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-800/70 transition";
                row.innerHTML = `
                    <td class="px-8 py-5">${user.name || '‚Äî'}</td>
                    <td class="px-8 py-5 text-green-400">${user.email}</td>
                    <td class="px-8 py-5 text-gray-400">${new Date(user.joined).toLocaleDateString('en-ZA')}</td>
                    <td class="px-8 py-5 text-center">
                        <button onclick="flagUser('${user.email}')" 
                                class="text-amber-400 hover:text-amber-300 text-xs font-medium flex items-center gap-1 mx-auto">
                            <i class="fas fa-flag"></i> FLAG
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderListingsTable() {
            const tbody = document.getElementById('listings-table');
            tbody.innerHTML = '';
            
            Object.values(listingsData).sort((a,b) => b.posted - a.posted).forEach(listing => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-800/70 transition";
                row.innerHTML = `
                    <td class="px-8 py-5 font-medium">${listing.title}</td>
                    <td class="px-8 py-5">R${listing.price}</td>
                    <td class="px-8 py-5">${listing.quantity} tons</td>
                    <td class="px-8 py-5">${listing.location}</td>
                    <td class="px-8 py-5 text-green-400">${listing.seller}</td>
                    <td class="px-8 py-5 text-center">
                        <button onclick="deleteListing('${listing.id}')" 
                                class="bg-red-600 hover:bg-red-700 text-white text-xs px-5 py-2 rounded-2xl transition">
                            DELETE
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderRecentListings() {
            const container = document.getElementById('recent-listings');
            container.innerHTML = '';
            const recent = Object.values(listingsData)
                .sort((a,b) => b.posted - a.posted)
                .slice(0, 5);
            
            recent.forEach(l => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-800 rounded-2xl px-6 py-4";
                div.innerHTML = `
                    <div>
                        <div class="font-medium">${l.title}</div>
                        <div class="text-xs text-gray-400">${l.seller} ‚Ä¢ ${l.location}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-green-400 font-bold">R${l.price}</div>
                        <div class="text-xs text-gray-400">${l.quantity} tons</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ==================== DELETE LISTING ====================
        async function deleteListing(id) {
            if (!confirm("Delete this listing permanently?")) return;
            try {
                await db.ref('listings/' + id).remove();
                showToast("Listing deleted successfully");
            } catch (e) {
                showToast("Failed to delete listing", true);
            }
        }

        function flagUser(email) {
            showToast(`User ${email} has been flagged for review (demo)`);
        }

        // ==================== FILTERS ====================
        function filterUsers() {
            const term = document.getElementById('user-search').value.toLowerCase();
            const rows = document.querySelectorAll('#users-table tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        }

        function filterListings() {
            const term = document.getElementById('listing-search').value.toLowerCase();
            const rows = document.querySelectorAll('#listings-table tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        }

        // ==================== CHARTS ====================
        function initCharts() {
            // Growth Chart (mock + real feel)
            const ctx1 = document.getElementById('growthChart');
            growthChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Feb 20', 'Feb 21', 'Feb 22', 'Feb 23', 'Feb 24', 'Feb 25', 'Feb 26'],
                    datasets: [{
                        label: 'New Listings',
                        data: [12, 19, 15, 28, 22, 31, 45],
                        borderColor: '#10b981',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: '#374151' } }, x: { grid: { color: '#374151' } } }
                }
            });

            // Produce Chart
            const ctx2 = document.getElementById('produceChart');
            produceChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Maize', 'Tomatoes', 'Potatoes', 'Other'],
                    datasets: [{
                        data: [42, 28, 18, 12],
                        backgroundColor: ['#10b981', '#eab308', '#3b82f6', '#8b5cf6']
                    }]
                },
                options: {
                    plugins: { legend: { position: 'bottom', labels: { color: '#d1d5db', padding: 20 } } }
                }
            });
        }

        // ==================== SECTION SWITCH ====================
        function showSection(section) {
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            
            document.querySelectorAll('[id^="nav-"]').forEach(el => el.classList.remove('sidebar-link-active'));
            document.getElementById(`nav-${section}`).classList.add('sidebar-link-active');
            
            document.getElementById('page-title').textContent = {
                overview: 'Overview',
                users: 'Farmers',
                listings: 'Live Listings',
                analytics: 'Analytics'
            }[section];
        }

        // ==================== UTILITIES ====================
        function refreshAll() {
            showToast("Data refreshed");
            loadAllData();
        }

        function refreshListings() {
            renderListingsTable();
            showToast("Listings refreshed");
        }

        function showToast(msg, error = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-text').innerHTML = msg;
            toast.style.backgroundColor = error ? '#dc2626' : '#10b981';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        }

        // ==================== AUTO LOGIN REDIRECT ====================
        window.onload = () => {
            // If already logged in on main site, it will be handled by auth listener
            console.log("%c‚úÖ AgriConnect Admin Dashboard ready", "color:#10b981;font-size:14px;font-weight:bold");
        };
    </script>
</body>
</html>
